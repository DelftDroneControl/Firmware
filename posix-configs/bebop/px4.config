#!/bin/sh
# PX4 commands need the 'px4-' prefix in bash.
# (px4-alias.sh is expected to be in the PATH)
. px4-alias.sh

# See `~/src/Firmware/px4fmu_common/init.d-posix/rcS` for examples

# On `if` `then`:
# https://robots.thoughtbot.com/the-unix-shells-humble-if#negation-true-and-false

# On parameter expansion:
# https://unix.stackexchange.com/a/122848


IS_DAMAGED=${PX4_IS_DAMAGED:=true}
USE_EXTERNAL_VISION=${PX4_USE_EXTERNAL_VISION:=true}
POLL_LOG_POS_DIRECT_CONTROL_INPUT=${PX4_POLL_LOG_POS_DIRECT_CONTROL_INPUT:=true}

if POLL_LOG_POS_DIRECT_CONTROL_INPUT
then
	logger start -b 200 -t -r 0 -p pos_direct_control_input
else
	logger start -b 200 -t -r 0
fi


uorb start
param select /home/root/parameters
if [ -f /home/root/parameters ]
then
	param load
fi
param set SYS_AUTOSTART 4013
param set MAV_BROADCAST 1
param set MAV_TYPE 2

if $IS_DAMAGED; then
	param set SYS_HAS_MAG 0
	param set SYS_HAS_BARO 0
fi

if $USE_EXTERNAL_VISION; then
	param set EKF2_AID_MASK 24 # vision position/yaw
	param set EKF2_HGT_MODE 3 # vision
	param set EKF2_MAG_TYPE 4 # mc custom

	param set EKF2_EV_DELAY 0
	param set EKF2_EVP_NOISE 0.01

	param set EKF2_ACC_B_NOISE 0.1
	param set EKF2_ACC_NOISE 2
fi

param set SYS_MC_EST_GROUP 2

df_ms5607_wrapper start
df_mpu6050_wrapper start -R 8
df_ak8963_wrapper start -R 32
# Rangefinder disabled for now. It was found to cause delays of more than 10ms
#df_bebop_rangefinder_wrapper start
gps start -d /dev/ttyPA1
bebop_flow start
sensors start
commander start
ekf2 start
dataman start
navigator start
land_detector start multicopter

echo "[startup] PX4_CONTROL=$PX4_CONTROL"

# Use environment variable PX4_CONTROL to choose controller.
if [ "$PX4_CONTROL" = "sl_pos_direct" ]; then
	echo "[startup] Setting 'SYS_MC_CTRL_GRP' param to 3"
	param set SYS_MC_CTRL_GRP 3
else
	echo "[startup] Setting 'SYS_MC_CTRL_GRP' param to 1"
	param set SYS_MC_CTRL_GRP 1
fi

if param compare SYS_MC_CTRL_GRP 1
then
	param set MPC_XY_VEL_P 0.12
	param set MPC_XY_P 1.3
	param set MPC_XY_VEL_D 0.006
	param set MPC_XY_VEL_I 0.05
	param set MPC_XY_VEL_MAX 8

	param set MPC_Z_VEL_P 0.3
	param set MPC_Z_VEL_I 0.1

	param set MC_YAW_P 3.0
	param set MC_YAWRATE_P 0.05
	param set MC_YAWRATE_I 3.0

	param set MC_ROLLRATE_P 0.07
	param set MC_ROLLRATE_I 0.5
	param set MC_ROLLRATE_D 0.0
	param set MC_RR_INT_LIM 0.5

	param set MC_PITCHRATE_P 0.1
	param set MC_PITCHRATE_I 0.8
	param set MC_PITCHRATE_D 0.0
	param set MC_PR_INT_LIM 0.5

	mc_att_control start
	mc_pos_control start
fi

if param compare SYS_MC_CTRL_GRP 3
then
	param set SL_ROT_DIRECTION -1
	sl_pos_direct_control start
fi

sleep 1
mavlink start -x -u 14556 -r 20000
sleep 1

mavlink stream -u 14556 -s HIGHRES_IMU -r 50
mavlink stream -u 14556 -s ATTITUDE -r 50
mavlink stream -r 50 -s ACTUATOR_CONTROL_TARGET0 -u 14556
if $USE_EXTERNAL_VISION; then
	mavlink stream -r 50 -s VISION_POSITION_ESTIMATE -u 14556
fi

df_bebop_bus_wrapper start
mavlink boot_complete
